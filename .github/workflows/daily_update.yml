name: Jason TV Daily Auto Update
on:
  schedule:
    - cron: '30 1 * * *' # å°åŒ—æ™‚é–“ 09:30 (UTC 01:30)
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼
  
permissions:
  contents: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. ä¸‹è¼‰ç¨‹å¼ç¢¼
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # ç¢ºä¿å®Œæ•´æ­·å²ç´€éŒ„
      
      - name: 2. è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'  # åŠ é€Ÿå®‰è£
          
      - name: 3. å®‰è£å¿…è¦å¥—ä»¶
        run: |
          pip install --upgrade pip
          pip install requests yfinance pandas lxml google-generativeai
          pip list  # é¡¯ç¤ºå·²å®‰è£å¥—ä»¶ï¼ˆé™¤éŒ¯ç”¨ï¼‰
          
      - name: 4. åŸ·è¡Œ Jason TV è…³æœ¬
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          echo "é–‹å§‹åŸ·è¡Œ update.py..."
          python update.py
          echo "è…³æœ¬åŸ·è¡Œå®Œæˆ"
        
      - name: 5. æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ (é™¤éŒ¯)
        run: |
          echo "=== æª¢æŸ¥ index.html æ˜¯å¦å­˜åœ¨ ==="
          if [ -f index.html ]; then
            echo "âœ… index.html å·²ç”Ÿæˆ"
            echo "æª”æ¡ˆå¤§å°: $(wc -c < index.html) bytes"
            echo "å‰ 30 è¡Œå…§å®¹:"
            head -30 index.html
          else
            echo "âŒ éŒ¯èª¤: index.html ä¸å­˜åœ¨!"
            ls -la
            exit 1
          fi
        
      - name: 6. æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        id: check_changes
        run: |
          git diff --quiet index.html || echo "changed=true" >> $GITHUB_OUTPUT
          
      - name: 7. æäº¤ä¸¦æ¨é€è®Šæ›´
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --global user.name "Jason-TV-Bot"
          git config --global user.email "bot@jason.tv"
          git add index.html
          git commit -m "ğŸ¤– Auto update: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S') (å°åŒ—æ™‚é–“)"
          git push
          echo "âœ… å·²æ¨é€æ›´æ–°åˆ° GitHub"
          
      - name: 8. ç„¡è®Šæ›´é€šçŸ¥
        if: steps.check_changes.outputs.changed != 'true'
        run: |
          echo "â„¹ï¸ index.html æ²’æœ‰è®Šæ›´ï¼Œè·³é commit"
          
      - name: 9. ä¸Šå‚³æ—¥èªŒ (å¤±æ•—æ™‚å¯æŸ¥çœ‹)
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: debug-logs
          path: |
            *.log
            index.html
          retention-days: 7
